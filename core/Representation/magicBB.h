#ifndef MAGICBB_H
#define MAGICBB_H

#include <iostream>
#include <cassert>

#include "bitboard.h"


using namespace std;

typedef unsigned long long Key;

struct Magic
{
    Bitboard mask;     // The mask for the rook
    Key magic;         // The magic number
    Bitboard *table{}; // The table for the magic moves
    uint8_t shift;     // The shift for the magic number

    Magic() : mask(0), magic(0), shift(0) {}
    Magic(Bitboard mask, Key magic, uint8_t shift) : mask(mask), magic(magic), shift(shift) {}
};

extern Bitboard rookMasks[64];
extern Magic rookMagics[64];

extern Bitboard bishopMasks[64];
extern Magic bishopMagics[64];

// Returns the key for the given bitboard and magic number
inline int getKey(const Bitboard bb, const Magic *magic)
{
    return (bb * magic->magic) >> magic->shift;
}


namespace
{
    Magic _rookMagicsPre[64] = {
        Magic(282578800148862, 4152319171632300160ULL, 51),
        Magic(565157600297596, 14843852015158695816ULL, 52),
        Magic(1130315200595066, 4476054028031823148ULL, 52),
        Magic(2260630401190006, 15017538549441283126ULL, 52),
        Magic(4521260802379886, 14401240668721589855ULL, 51),
        Magic(9042521604759646, 16717280127816069915ULL, 52),
        Magic(18085043209519166, 7247297081838487901ULL, 52),
        Magic(36170086419038334, 1873498225240959660ULL, 51),
        Magic(282578800180736, 639880437875271486ULL, 52),
        Magic(565157600328704, 14608829458150731288ULL, 53),
        Magic(1130315200625152, 8980076453930880435ULL, 53),
        Magic(2260630401218048, 4870775457303048619ULL, 53),
        Magic(4521260802403840, 8589989316580159768ULL, 53),
        Magic(9042521604775424, 13348947101683945725ULL, 53),
        Magic(18085043209518592, 10181513116082443816ULL, 54),
        Magic(36170086419037696, 5045720434831267657ULL, 53),
        Magic(282578808340736, 2781572535204828492ULL, 52),
        Magic(565157608292864, 2574554275451440592ULL, 53),
        Magic(1130315208328192, 4241346313129223745ULL, 53),
        Magic(2260630408398848, 16518782862424527015ULL, 53),
        Magic(4521260808540160, 1686173648691972608ULL, 53),
        Magic(9042521608822784, 11960223565862735863ULL, 53),
        Magic(18085043209388032, 9526964789495484426ULL, 54),
        Magic(36170086418907136, 6474568778226111309ULL, 53),
        Magic(282580897300736, 8426100081639669771ULL, 53),
        Magic(565159647117824, 16596743649308087505ULL, 53),
        Magic(1130317180306432, 7346919059479760950ULL, 53),
        Magic(2260632246683648, 14371284292917425138ULL, 53),
        Magic(4521262379438080, 4865841985946081796ULL, 53),
        Magic(9042522644946944, 2861642092874445412ULL, 53),
        Magic(18085043175964672, 5400854115534833160ULL, 54),
        Magic(36170086385483776, 5841109660902457604ULL, 53),
        Magic(283115671060736, 600530986156949607ULL, 53),
        Magic(565681586307584, 3795815478700137619ULL, 53),
        Magic(1130822006735872, 10697034315488521040ULL, 53),
        Magic(2261102847592448, 11601912105345228448ULL, 53),
        Magic(4521664529305600, 14065264736519509011ULL, 53),
        Magic(9042787892731904, 2749709054450275731ULL, 53),
        Magic(18085034619584512, 9485152633833391362ULL, 54),
        Magic(36170077829103616, 1736378294946759561ULL, 53),
        Magic(420017753620736, 16978223244589936641ULL, 52),
        Magic(699298018886144, 4158618999127115659ULL, 53),
        Magic(1260057572672512, 7209184294986389224ULL, 53),
        Magic(2381576680245248, 16684767935061554605ULL, 53),
        Magic(4624614895390720, 11483554228871510109ULL, 53),
        Magic(9110691325681664, 2140338540292960242ULL, 53),
        Magic(18082844186263552, 2625660362678337581ULL, 54),
        Magic(36167887395782656, 9562632954719895561ULL, 53),
        Magic(35466950888980736, 6029059897839518208ULL, 53),
        Magic(34905104758997504, 4978166990608078336ULL, 54),
        Magic(34344362452452352, 5224904827899551418ULL, 53),
        Magic(33222877839362048, 2672881028962457601ULL, 53),
        Magic(30979908613181440, 5987251180183096832ULL, 53),
        Magic(26493970160820224, 15774803289197319488ULL, 53),
        Magic(17522093256097792, 15459676852661521408ULL, 54),
        Magic(35607136465616896, 14317637026106671616ULL, 53),
        Magic(9079539427579068672, 12859133735718642946ULL, 52),
        Magic(8935706818303361536, 5420645334034481346ULL, 53),
        Magic(8792156787827803136, 16228651989244838353ULL, 53),
        Magic(8505056726876686336, 8344796689223188569ULL, 53),
        Magic(7930856604974452736, 16133582768659505394ULL, 53),
        Magic(6782456361169985536, 772609881555939354ULL, 52),
        Magic(4485655873561051136, 10981341540498548260ULL, 53),
        Magic(9115426935197958144, 13247183564879856802ULL, 52),
    };

    Magic _bishopMagicsPre[64] = {
        Magic(18049651735527936, 16690349083940914708ULL, 58),
        Magic(70506452091904, 16580064367492596693ULL, 59),
        Magic(275415828992, 3510582498964904219ULL, 59),
        Magic(1075975168, 16940301015579222062ULL, 59),
        Magic(38021120, 3248225778483513770ULL, 59),
        Magic(8657588224, 4309385261403433361ULL, 59),
        Magic(2216338399232, 4953774889605071100ULL, 59),
        Magic(567382630219776, 8991718460728557604ULL, 58),
        Magic(9024825867763712, 14678006430170746369ULL, 59),
        Magic(18049651735527424, 510934417625843970ULL, 59),
        Magic(70506452221952, 12616183462937634474ULL, 59),
        Magic(275449643008, 15572154608331344882ULL, 59),
        Magic(9733406720, 4430238021420339700ULL, 59),
        Magic(2216342585344, 17488221740080309900ULL, 59),
        Magic(567382630203392, 3648805770282807636ULL, 59),
        Magic(1134765260406784, 539153507233582604ULL, 59),
        Magic(4512412933816832, 13756337989329097783ULL, 59),
        Magic(9024825867633664, 16726388294151637469ULL, 59),
        Magic(18049651768822272, 7284572466224906928ULL, 57),
        Magic(70515108615168, 7604341491473965135ULL, 57),
        Magic(2491752130560, 6403697505688636735ULL, 57),
        Magic(567383701868544, 5430498005604763945ULL, 57),
        Magic(1134765256220672, 4984945728437373447ULL, 59),
        Magic(2269530512441344, 4411838952494448041ULL, 59),
        Magic(2256206450263040, 2717993077665077329ULL, 59),
        Magic(4512412900526080, 12497510968574097957ULL, 59),
        Magic(9024834391117824, 2688798555951374881ULL, 57),
        Magic(18051867805491712, 323551084158844912ULL, 54),
        Magic(637888545440768, 15917641139561918027ULL, 54),
        Magic(1135039602493440, 14438173169925773773ULL, 57),
        Magic(2269529440784384, 6015131300372618532ULL, 59),
        Magic(4539058881568768, 9795126094804883473ULL, 59),
        Magic(1128098963916800, 5204226922801822842ULL, 59),
        Magic(2256197927833600, 11994783952687755277ULL, 59),
        Magic(4514594912477184, 14324368148875708545ULL, 57),
        Magic(9592139778506752, 11277982992272616102ULL, 54),
        Magic(19184279556981248, 9335288171630538321ULL, 54),
        Magic(2339762086609920, 2961742677771354503ULL, 57),
        Magic(4538784537380864, 1364602975113790469ULL, 59),
        Magic(9077569074761728, 6639163270528565488ULL, 59),
        Magic(562958610993152, 12040394044072330692ULL, 59),
        Magic(1125917221986304, 15025921576003857443ULL, 59),
        Magic(2814792987328512, 11471298009350889344ULL, 57),
        Magic(5629586008178688, 10200728271818369025ULL, 57),
        Magic(11259172008099840, 14937947601839062545ULL, 57),
        Magic(22518341868716544, 5107198014582372864ULL, 57),
        Magic(9007336962655232, 3604049797333228550ULL, 59),
        Magic(18014673925310464, 4292038221118592246ULL, 59),
        Magic(2216338399232, 17510551639460068779ULL, 59),
        Magic(4432676798464, 4925005060668144057ULL, 59),
        Magic(11064376819712, 16886105255133053789ULL, 59),
        Magic(22137335185408, 13463706739511141909ULL, 59),
        Magic(44272556441600, 17488948575907218350ULL, 59),
        Magic(87995357200384, 7480947718007948081ULL, 59),
        Magic(35253226045952, 8022986740644311650ULL, 59),
        Magic(70506452091904, 8847511791761490296ULL, 59),
        Magic(567382630219776, 17656929978425810985ULL, 58),
        Magic(1134765260406784, 6976073628164555876ULL, 59),
        Magic(2832480465846272, 6622697571728704655ULL, 59),
        Magic(5667157807464448, 4793349532511406136ULL, 59),
        Magic(11333774449049600, 12513409513565463556ULL, 59),
        Magic(22526811443298304, 11674090828329651976ULL, 59),
        Magic(9024825867763712, 13548112117288339529ULL, 59),
        Magic(18049651735527936, 16526046862517403745ULL, 58),
    };
};

extern void precomputeRookMoves();
extern void precomputeBishopMoves();

#endif // MAGICBB_H